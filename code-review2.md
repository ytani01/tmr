# Code Review - Round 2: src/tmr/

## 1. 概要
前回のレビュー (`code-review1.md`) に引き続き、`src/tmr/` 以下のソースコードの詳細レビューを行いました。
本レビューでは、前回指摘事項の修正状況の確認と、より詳細なコード分析による新規課題の洗い出しを行いました。

**現状の結論:**
前回のレビューで指摘された事項の多くは未修正のままです。特にスレッド管理や動的型付けに関する潜在的なリスクは残存しています。
また、`pomodoro` コマンドの実装において、ネストが深く複雑なロジックが含まれており、可読性と保守性に課題があります。

---

## 2. 前回指摘事項の確認 (未修正項目)

`code-review1.md` で指摘された項目のうち、依然として修正が必要な重要項目を再掲します。

### logic Correctness & Efficiency
- **[Critical] スレッドの終了処理 (`base_timer.py`)**
  - `ring_alarm` で生成されるスレッドが `daemon=True` ですが、メインプロセス終了時のクリーンアップが不十分な可能性があります。
  - アラーム鳴動中に `KeyboardInterrupt` 等で強制終了した場合、端末の状態（カーソル非表示など）が復帰しないリスクがあります。

- **[High] `while` ループ内のインスタンス化 (`__main__.py`)**
  - `pomodoro` コマンド内で `while True` ループのたびに `BaseTimer` を `new` しています。
  - 設計として意図的かもしれませんが、リソース管理の観点からは再利用またはコンテキストマネージャによる明確な寿命管理が望ましいです。

### Type Safety
- **[Medium] 型ヒントの不完全さ**
  - `arlarm_params` (typo含む) が `tuple` として定義されていますが、要素の型が明示されていません（例: `tuple[int, float, float]`）。
  - `col_list` の戻り値が `dict` となっていますが、`dict[str, TimerCol]` とすべきです。

### Test Quality & Coverage
- **[Critical] カバレッジ不足**
  - `__main__.py`, `click_utils.py`, `mylog.py` のテストが存在せず、ロジック（特にポモドーロの状態遷移）が検証されていません。

---

## 3. 新規指摘コードレビュー

今回の詳細分析により発見された新たな課題です。

### A. 設計とアーキテクチャ (`__main__.py`)
- **コンプレキシティの高さ**
  - `pomodoro` 関数内のループ構造が非常に深く (`while` -> `for` -> `if` -> `main()`)、可読性が低くなっています。
  - **提案:** ポモドーロの状態管理（Work, Short Break, Long Break の遷移）を `PomodoroTimer` クラスとして切り出し、状態遷移ロジックをカプセル化することを推奨します。

- **例外処理の重複**
  - `timer` コマンドと `pomodoro` コマンドの両方で、`KeyboardInterrupt` の捕捉と `finally` 句でのカーソル復帰処理 (`ESQ_CSR_ON`) が重複しています。
  - **提案:** これらをラップするコンテキストマネージャ（例: `TerminalContext`）を作成し、`with` 句で囲むことで安全かつ簡潔に記述できます。

### B. モジュール構成と定数管理 (`__init__.py` 他)
- **`__all__` の不整合**
  - `src/tmr/__init__.py` おいて、`ESQ_EL1`, `ESQ_EL2` が定義されていますが、`__all__` リストに含まれていません。
  - 外部モジュール（`__main__.py` 等）からはインポートできていますが、明示的なエクスポートが欠けています。

- **グローバル変数の散在**
  - 色設定 (`cyan`, `yellow` 等) や時間設定が、`__main__.py` や `base_timer.py` のクラス変数、ローカル変数として散在しています。
  - **提案:** `config.py` や `constants.py` を作成し、設定値を一元管理することで、変更が容易になります。

### C. 潜在的なバグと挙動 (`progress_bar.py`)
- **表示の不整合**
  - `get_str` メソッド内で `round(rate * bar_len)` を使用していますが、進捗率が 100% 未満でも四捨五入によりバーが満杯に見える場合があります（例: 99.9%）。
  - 通常、プログレスバーは「完了した割合」を切り捨て (`int()`) または `math.floor` で表現するのが一般的です。

### D. 静的解析対応 (`mypy`)
- **型チェックの厳格化**
  - 現状の型ヒントは部分的です。`mypy --strict` 相当のチェックを行うと多数のエラーが出る可能性があります。
  - 特に `dict` や `list` のジェネリック型引数（`dict[str, Any]` 等）を省略せず記述することで、堅牢性が向上します。

---

## 4. 改善アクションプラン

優先度順に対処すべきタスクを提案します。

1. **リファクタリング: 共通処理の切り出し**
    - `KeyboardInterrupt` とカーソル制御を行うコンテキストマネージャの実装。
    - 重複コードの削除。

2. **テストの追加**
    - `__main__.py` のロジック（特にポモドーロのサイクル計算）に対する単体テストの追加。
    - `click.testing.CliRunner` を用いた結合テストの作成。

3. **型ヒントの修正**
    - `__init__.py` の `__all__` 修正。
    - `BaseTimer` 周りの型定義の具体化。

4. **ポモドーロロジックのクラス化** (中期的目標)
    - `__main__.py` からロジックを剥がし、テスタブルなクラスに移行する。
